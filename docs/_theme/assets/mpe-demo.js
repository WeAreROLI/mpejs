var context = new AudioContext();
var clock = new window.WAAClock(context);
var mpeInstrument = new window.mpe();
var video = document.getElementById('mpe-video');
var mpeCanvas = document.getElementById('mpe-visualizer');
var mpeCtx = mpeCanvas.getContext('2d');
var mpeW, mpeH;
var mpeOutput = document.getElementById('mpe-output');
var midiInput = document.getElementById('midi-input');
// var tabButtons = Array.from(document.getElementsByClassName('tab-button'));
// var tabChildren = Array.from(document.getElementsByClassName('tab-child'));
// var activeTab = 'mpe-output';
var newMidiMessages = [];

var TEMPO = 120;
var BEAT_LENGTH_S = 60 / TEMPO;
var BEAT_LENGTH_TICKS = 960;
var MAX_MIDI_MESSAGES = 25;
var BLACK_KEYS = [1, 3, 6, 8, 10];
var BLACK_KEY_LINE_WIDTH = 4;
var KEY_CENTERS = {
  0: 0.5 / 8,
  1: 1 / 8,
  2: 1.5 / 8,
  3: 2 / 8,
  4: 2.5 / 8,
  5: 3.5 / 8,
  6: 4 / 8,
  7: 4.5 / 8,
  8: 5 / 8,
  9: 5.5 / 8,
  10: 6 / 8,
  11: 6.5 / 8,
  12: 7.5 / 8,
};

var timedMidi = [[1400,226,0,64],[0,178,74,36],[0,146,62,47],[22,226,16,64],[22,210,101],[0,178,74,38],[23,210,103],[0,226,0,64],[22,210,107],[22,210,111],[23,210,115],[22,210,117],[0,226,127,63],[22,226,0,64],[22,226,127,63],[67,210,116],[45,210,117],[0,178,74,39],[22,210,117],[45,210,116],[178,178,74,40],[112,210,115],[66,178,74,41],[23,210,116],[67,210,115],[22,226,0,64],[22,226,127,63],[45,210,114],[22,210,113],[22,210,112],[0,178,74,42],[23,210,111],[44,210,110],[22,178,74,43],[45,226,126,63],[22,210,111],[0,226,127,63],[23,178,74,44],[89,210,110],[0,178,74,45],[44,226,126,63],[23,178,74,46],[22,210,111],[22,210,112],[23,178,74,47],[66,210,113],[0,178,74,48],[45,210,114],[22,178,74,49],[67,210,113],[0,178,74,50],[45,210,114],[44,210,115],[45,178,74,51],[22,210,114],[22,226,127,63],[23,210,112],[22,210,110],[0,178,74,53],[22,210,108],[0,226,0,64],[23,210,106],[0,178,74,54],[22,210,105],[22,210,104],[0,226,127,63],[23,210,102],[0,178,74,55],[22,210,104],[0,226,126,63],[22,210,105],[0,178,74,56],[22,210,107],[23,210,108],[0,178,74,57],[22,210,109],[0,178,74,59],[22,210,110],[0,178,74,60],[23,210,109],[0,178,74,61],[22,178,74,63],[22,210,107],[0,226,127,63],[22,210,105],[0,178,74,64],[23,210,102],[22,226,126,63],[0,178,74,65],[22,210,98],[23,210,96],[0,226,125,63],[22,226,126,63],[0,178,74,66],[22,210,100],[0,178,74,67],[22,210,102],[0,178,74,68],[23,210,102],[22,178,74,70],[22,210,105],[23,226,0,64],[0,178,74,72],[22,210,107],[22,210,106],[0,178,74,73],[23,210,105],[0,178,74,74],[22,210,101],[0,178,74,76],[22,210,99],[0,226,127,63],[22,210,100],[23,210,98],[0,226,1,64],[22,210,98],[22,210,98],[0,178,74,77],[23,210,96],[0,178,74,78],[22,210,94],[0,178,74,80],[22,210,93],[0,226,0,64],[22,178,74,83],[23,210,92],[0,226,1,64],[22,210,91],[0,178,74,85],[22,210,90],[0,178,74,86],[23,210,87],[0,178,74,87],[22,210,89],[22,210,87],[0,226,127,63],[22,210,85],[0,226,0,64],[23,210,85],[0,226,1,64],[22,210,86],[0,178,74,88],[22,210,88],[0,226,127,63],[23,210,89],[0,178,74,89],[22,210,87],[0,226,0,64],[22,210,86],[0,178,74,90],[22,210,85],[0,226,127,63],[0,178,74,92],[23,210,84],[0,178,74,93],[22,210,83],[0,226,126,63],[22,210,82],[0,178,74,94],[23,210,81],[0,178,74,95],[22,210,79],[0,178,74,96],[22,210,79],[0,226,125,63],[0,178,74,97],[23,210,78],[22,210,76],[0,226,123,63],[0,178,74,98],[22,210,73],[0,226,126,63],[22,210,71],[0,226,127,63],[23,210,70],[0,226,0,64],[22,210,71],[0,226,127,63],[0,178,74,101],[22,210,70],[0,178,74,103],[23,210,68],[22,210,67],[0,226,0,64],[0,178,74,105],[22,210,64],[0,178,74,106],[22,210,66],[0,226,125,63],[0,178,74,108],[23,210,70],[22,210,72],[0,178,74,109],[22,210,72],[23,210,74],[0,226,126,63],[22,210,73],[0,226,127,63],[22,210,71],[0,226,1,64],[22,210,68],[23,210,67],[0,226,0,64],[22,210,66],[0,178,74,110],[22,210,67],[0,226,125,63],[23,226,119,63],[0,178,74,113],[22,210,71],[22,210,73],[0,226,118,63],[0,178,74,115],[23,210,76],[0,178,74,116],[22,210,74],[0,178,74,117],[22,210,76],[0,178,74,118],[22,210,78],[0,226,122,63],[23,210,80],[0,178,74,119],[22,210,82],[0,226,121,63],[22,226,117,63],[23,210,79],[22,210,78],[22,210,79],[22,210,78],[0,226,118,63],[23,210,74],[0,226,117,63],[22,210,75],[0,178,74,120],[22,210,74],[0,226,118,63],[23,210,72],[22,210,75],[22,210,76],[0,226,117,63],[22,178,74,122],[23,210,77],[0,178,74,123],[22,226,118,63],[22,210,78],[0,178,74,124],[23,226,119,63],[0,178,74,125],[22,210,77],[0,226,122,63],[22,210,78],[0,226,123,63],[0,178,74,126],[23,210,80],[0,226,125,63],[22,210,84],[22,210,85],[0,226,126,63],[22,210,83],[0,178,74,127],[23,210,81],[0,226,125,63],[22,210,77],[22,210,79],[23,210,81],[0,226,123,63],[22,210,83],[0,226,125,63],[134,210,82],[22,226,126,63],[22,210,81],[0,226,125,63],[45,210,80],[22,210,78],[22,210,74],[23,210,71],[22,210,70],[0,226,126,63],[22,210,66],[23,210,64],[22,210,63],[0,226,125,63],[22,210,64],[0,226,122,63],[22,210,63],[0,178,74,123],[23,210,62],[0,226,113,63],[22,210,61],[0,178,74,120],[22,210,63],[0,226,111,63],[23,210,65],[0,226,115,63],[0,178,74,119],[22,210,69],[22,210,71],[0,226,117,63],[22,210,67],[23,210,65],[0,226,10,64],[0,178,74,116],[22,210,63],[0,178,74,109],[22,210,59],[0,226,22,64],[23,210,57],[0,226,20,64],[22,210,53],[0,226,10,64],[0,178,74,108],[22,210,49],[0,226,17,64],[0,178,74,102],[22,210,47],[0,226,2,64],[0,178,74,98],[23,210,48],[0,226,127,63],[22,210,46],[0,178,74,97],[22,210,46],[0,226,2,64],[0,178,74,92],[23,210,42],[0,226,10,64],[22,210,44],[0,178,74,87],[22,210,50],[22,210,46],[0,226,14,64],[23,210,44],[0,226,25,64],[22,210,42],[0,210,40],[0,178,74,80],[45,210,40],[0,226,16,64],[0,178,74,77],[22,210,44],[0,226,126,63],[22,210,46],[0,226,125,63],[0,178,74,76],[23,210,50],[0,226,123,63],[22,210,56],[22,210,60],[22,210,62],[0,226,122,63],[23,210,58],[0,226,121,63],[22,210,56],[0,226,123,63],[22,210,56],[0,226,115,63],[0,178,74,75],[23,210,60],[0,226,110,63],[0,178,74,69],[22,210,61],[0,226,103,63],[0,178,74,67],[22,210,58],[0,226,105,63],[0,178,74,66],[22,210,62],[23,210,64],[0,226,106,63],[22,210,64],[0,226,103,63],[22,210,62],[0,226,102,63],[23,210,60],[0,226,97,63],[22,210,58],[0,226,91,63],[22,210,54],[0,226,86,63],[22,210,50],[23,210,46],[22,210,44],[0,178,74,65],[22,210,40],[0,226,0,64],[23,210,38],[0,178,74,64],[22,210,34],[0,226,93,63],[0,178,74,60],[22,210,32],[0,226,107,63],[0,178,74,56],[23,210,28],[0,226,103,63],[0,178,74,55],[22,210,32],[0,226,99,63],[22,210,31],[0,226,90,63],[22,210,27],[0,226,0,64],[23,210,25],[22,210,22],[22,210,18],[23,210,14],[22,210,13],[0,226,107,63],[22,210,12],[0,226,117,63],[22,210,10],[0,178,74,54],[23,210,10],[0,226,107,63],[22,210,8],[0,226,86,63],[0,178,74,50],[22,210,6],[0,226,0,64],[0,178,74,48],[23,210,2],[0,178,74,46],[22,210,0],[0,178,74,45],[22,210,1],[0,178,74,44],[22,210,4],[23,210,8],[22,210,12],[22,210,16],[23,210,20],[22,210,24],[22,210,28],[23,210,32],[22,210,36],[22,210,40],[22,210,44],[23,210,46],[22,210,50],[22,210,46],[23,210,42],[22,210,38],[22,210,34],[22,210,32],[23,210,28],[22,210,24],[22,210,22],[23,210,18],[22,210,16],[22,210,12],[22,210,8],[23,210,6],[22,210,2],[22,210,0],[134,178,74,42],[22,178,74,38],[23,178,74,36],[22,178,74,35],[22,178,74,34],[23,178,74,33],[1359,210,2],[23,210,4],[0,178,74,34],[22,210,8],[22,210,10],[0,226,86,63],[0,178,74,35],[22,210,12],[0,226,87,63],[23,210,14],[0,227,0,64],[0,179,74,67],[0,147,70,14],[22,210,16],[0,226,91,63],[22,210,18],[0,227,113,63],[23,210,20],[0,211,54],[0,226,93,63],[22,210,24],[0,211,56],[0,227,110,63],[22,210,26],[0,211,58],[0,226,95,63],[0,227,114,63],[22,210,28],[0,210,32],[0,211,64],[0,226,110,63],[0,178,74,38],[23,210,36],[0,211,68],[0,226,111,63],[22,210,38],[0,211,72],[22,210,42],[0,211,74],[23,210,44],[0,211,78],[0,226,109,63],[22,210,41],[0,211,80],[0,226,102,63],[22,210,37],[0,211,84],[0,226,93,63],[0,178,74,36],[23,210,35],[0,211,88],[0,226,89,63],[22,210,31],[0,211,90],[22,210,28],[0,211,94],[0,226,93,63],[0,227,127,63],[22,210,30],[0,211,96],[0,178,74,38],[23,210,34],[0,211,100],[0,226,105,63],[22,210,36],[0,211,104],[0,226,106,63],[0,178,74,39],[22,210,40],[0,211,106],[23,210,44],[22,210,48],[22,210,49],[22,210,49],[23,210,50],[0,178,74,40],[44,210,49],[0,178,74,39],[23,210,48],[44,210,46],[22,210,47],[0,211,105],[23,211,106],[0,226,105,63],[22,210,48],[0,211,105],[22,210,49],[0,226,106,63],[23,210,51],[22,210,54],[22,226,107,63],[45,210,55],[22,226,109,63],[0,178,74,40],[22,210,56],[45,210,57],[22,178,74,39],[23,210,58],[0,178,74,40],[22,210,59],[0,178,74,39],[67,210,60],[22,211,104],[22,210,61],[0,226,110,63],[23,210,62],[0,211,105],[44,227,126,63],[45,227,127,63],[22,210,63],[22,226,111,63],[23,210,64],[44,211,106],[134,210,65],[67,179,74,68],[44,211,107],[45,210,64],[45,211,108],[66,210,63],[0,211,109],[23,210,64],[22,210,63],[0,226,110,63],[22,210,62],[0,179,74,69],[45,210,63],[44,210,64],[0,211,110],[23,211,111],[0,226,111,63],[0,179,74,70],[22,211,112],[0,179,74,71],[22,210,63],[0,211,111],[23,226,110,63],[0,227,126,63],[22,210,62],[0,211,110],[22,210,61],[0,178,74,40],[23,227,127,63],[0,179,74,72],[22,211,109],[22,210,62],[0,211,108],[0,226,111,63],[22,227,0,64],[0,179,74,73],[67,179,74,74],[23,211,107],[22,210,63],[22,210,64],[0,211,106],[0,226,113,63],[22,210,65],[0,179,74,75],[45,227,1,64],[0,179,74,76],[22,210,67],[0,178,74,41],[23,210,69],[0,226,111,63],[22,210,71],[0,178,74,42],[22,210,73],[0,226,110,63],[22,210,76],[0,226,109,63],[23,210,75],[0,226,110,63],[22,210,76],[0,226,109,63],[22,210,76],[23,211,105],[0,179,74,77],[22,210,77],[0,211,104],[22,210,78],[0,179,74,78],[23,210,79],[0,226,110,63],[22,211,104],[22,210,80],[0,211,105],[22,210,79],[0,179,74,79],[23,211,106],[0,178,74,43],[22,210,78],[0,178,74,42],[22,211,106],[23,227,2,64],[0,179,74,80],[22,210,79],[0,178,74,43],[22,210,80],[0,211,107],[22,211,108],[0,179,74,81],[23,210,81],[0,179,74,82],[22,210,82],[0,226,111,63],[22,211,107],[0,179,74,83],[23,210,83],[0,211,106],[0,179,74,84],[66,227,4,64],[0,179,74,85],[23,211,105],[22,210,84],[0,211,106],[0,179,74,86],[45,211,105],[22,179,74,87],[22,226,113,63],[23,226,111,63],[22,179,74,88],[22,226,113,63],[0,227,5,64],[22,211,107],[23,210,85],[0,227,8,64],[22,211,111],[22,211,112],[0,227,10,64],[23,211,114],[0,227,13,64],[22,210,86],[0,179,74,89],[22,211,115],[0,227,14,64],[22,210,85],[0,211,116],[23,210,86],[0,211,115],[22,227,13,64],[0,179,74,90],[45,211,116],[22,227,14,64],[0,179,74,91],[22,211,117],[0,226,114,63],[22,210,87],[0,211,118],[23,179,74,92],[22,211,117],[0,227,13,64],[22,211,116],[0,227,12,64],[23,211,117],[0,179,74,93],[22,211,119],[0,227,6,64],[0,179,74,95],[22,211,121],[0,227,2,64],[22,211,121],[23,211,120],[0,227,1,64],[22,227,127,63],[0,179,74,96],[22,211,119],[45,179,74,97],[22,211,122],[23,210,88],[0,211,123],[0,227,1,64],[22,211,125],[0,179,74,98],[22,210,87],[0,227,5,64],[22,211,127],[0,227,10,64],[23,210,88],[0,227,13,64],[22,227,14,64],[0,179,74,99],[22,210,89],[0,226,115,63],[23,227,16,64],[22,227,14,64],[22,210,88],[0,226,114,63],[22,227,13,64],[0,179,74,100],[23,210,89],[0,227,12,64],[22,226,115,63],[0,227,9,64],[22,211,125],[0,227,5,64],[23,211,121],[22,211,120],[0,227,2,64],[22,211,119],[0,226,114,63],[22,210,88],[0,227,1,64],[0,179,74,101],[23,210,87],[0,227,0,64],[22,211,118],[0,227,127,63],[0,179,74,102],[22,179,74,103],[45,178,74,44],[0,179,74,104],[22,210,88],[0,178,74,43],[23,210,89],[0,211,120],[0,226,115,63],[22,211,119],[0,227,2,64],[0,179,74,105],[22,211,117],[0,179,74,108],[22,211,115],[0,227,12,64],[23,211,113],[0,227,17,64],[22,211,115],[0,178,74,44],[22,227,20,64],[0,179,74,109],[23,211,115],[22,211,116],[0,227,21,64],[44,210,90],[0,211,115],[0,227,22,64],[0,179,74,110],[23,211,114],[0,227,25,64],[22,227,26,64],[0,179,74,111],[22,210,91],[0,211,113],[23,211,114],[0,226,117,63],[0,227,28,64],[22,211,115],[0,227,29,64],[0,179,74,112],[22,210,92],[0,211,114],[22,211,113],[0,227,28,64],[23,210,93],[22,211,111],[0,227,26,64],[0,179,74,113],[22,211,107],[0,227,18,64],[0,179,74,114],[23,211,105],[0,226,118,63],[0,179,74,116],[22,210,94],[0,211,101],[0,227,13,64],[22,211,103],[0,211,107],[0,179,74,120],[23,210,95],[0,211,109],[0,227,38,64],[22,210,96],[0,211,113],[0,179,74,121],[22,210,97],[0,211,115],[0,227,37,64],[22,210,98],[0,211,119],[0,226,119,63],[0,227,34,64],[0,179,74,122],[23,210,99],[0,211,115],[0,227,24,64],[0,179,74,124],[22,211,113],[0,226,121,63],[0,227,10,64],[22,211,109],[0,211,107],[0,227,10,64],[0,179,74,127],[23,210,105],[0,211,103],[0,226,122,63],[0,227,28,64],[0,178,74,45],[22,210,107],[0,211,99],[0,226,123,63],[22,210,110],[0,211,97],[0,226,125,63],[0,227,127,63],[22,210,113],[0,211,93],[0,227,0,64],[23,210,115],[0,211,95],[0,226,126,63],[0,178,74,46],[22,210,119],[0,211,99],[22,210,120],[0,211,103],[0,178,74,47],[23,210,124],[0,226,119,63],[0,131,70,31],[22,210,124],[0,226,121,63],[22,210,121],[0,226,126,63],[22,210,119],[0,226,127,63],[0,178,74,46],[23,210,118],[0,226,126,63],[22,210,114],[0,178,74,45],[22,210,110],[23,210,108],[0,226,125,63],[22,210,104],[0,226,123,63],[0,178,74,44],[22,210,106],[0,178,74,45],[22,210,110],[0,226,125,63],[23,210,113],[22,210,112],[0,226,126,63],[22,210,111],[0,226,125,63],[23,210,109],[0,226,123,63],[22,210,107],[0,178,74,44],[22,210,103],[0,226,122,63],[23,210,102],[111,210,104],[45,210,103],[22,210,102],[22,210,101],[22,210,99],[0,226,121,63],[23,210,98],[0,226,119,63],[22,210,97],[0,226,118,63],[22,210,96],[23,210,97],[22,226,119,63],[22,210,98],[22,210,97],[23,226,118,63],[22,210,95],[22,210,94],[0,226,117,63],[23,210,93],[44,210,92],[23,210,91],[0,226,115,63],[22,210,90],[0,226,114,63],[22,210,89],[45,178,74,43],[22,210,88],[22,210,87],[23,210,86],[0,226,113,63],[22,210,85],[0,226,111,63],[22,210,84],[0,226,110,63],[45,210,79],[22,210,77],[0,226,107,63],[22,210,76],[0,226,106,63],[23,210,72],[0,178,74,42],[22,210,70],[0,226,109,63],[22,210,71],[0,178,74,43],[22,210,71],[45,226,113,63],[0,178,74,41],[22,210,67],[23,210,63],[22,210,61],[0,226,114,63],[22,210,59],[0,226,115,63],[0,178,74,40],[23,210,58],[0,226,117,63],[22,210,59],[0,226,118,63],[22,210,58],[22,210,59],[23,210,58],[44,210,57],[0,226,117,63],[23,210,55],[44,210,56],[45,210,57],[22,210,56],[22,210,55],[23,210,54],[0,226,115,63],[22,210,53],[0,178,74,41],[22,210,51],[22,210,49],[0,178,74,40],[45,210,51],[22,226,117,63],[23,210,49],[22,210,48],[22,210,46],[45,210,45],[22,210,43],[22,210,41],[0,226,118,63],[23,210,39],[0,178,74,39],[22,210,35],[0,226,117,63],[22,210,33],[0,226,114,63],[23,210,31],[0,226,117,63],[22,210,35],[22,226,121,63],[0,178,74,38],[22,210,39],[23,210,41],[0,226,125,63],[22,210,43],[0,226,126,63],[22,210,45],[0,228,0,64],[0,180,74,42],[0,148,69,2],[23,210,47],[0,226,127,63],[22,210,51],[0,212,18],[0,228,0,64],[0,178,74,37],[22,210,55],[0,212,20],[0,180,74,43],[22,210,57],[0,212,24],[0,228,38,64],[23,210,61],[0,212,26],[0,228,34,64],[22,210,63],[0,212,30],[0,228,29,64],[0,180,74,44],[22,210,65],[0,212,32],[23,210,71],[0,212,36],[0,226,126,63],[0,228,21,64],[22,210,73],[0,212,40],[0,228,16,64],[0,180,74,45],[22,212,42],[0,226,125,63],[0,228,10,64],[22,212,46],[0,228,8,64],[0,178,74,38],[23,210,75],[0,212,52],[0,228,6,64],[0,180,74,46],[22,210,77],[0,212,56],[0,228,4,64],[22,210,78],[0,212,58],[0,226,126,63],[0,228,2,64],[0,180,74,47],[23,212,62],[22,210,75],[0,212,64],[0,226,125,63],[0,228,1,64],[0,178,74,39],[22,210,71],[0,212,68],[0,226,123,63],[23,210,69],[0,212,72],[22,210,65],[0,212,74],[22,210,63],[0,212,78],[0,226,121,63],[22,210,59],[0,212,82],[0,228,2,64],[23,210,55],[0,212,84],[0,226,122,63],[0,228,1,64],[22,212,88],[0,178,74,40],[22,210,59],[0,212,90],[0,226,125,63],[0,178,74,39],[23,210,59],[0,212,94],[0,226,123,63],[22,210,57],[0,212,98],[0,178,74,40],[22,210,53],[0,212,100],[0,226,122,63],[0,228,2,64],[0,180,74,48],[22,210,51],[0,212,104],[0,226,121,63],[23,210,49],[0,212,106],[22,210,49],[0,212,108],[0,212,110],[0,228,10,64],[22,210,51],[0,212,114],[0,226,123,63],[0,228,13,64],[23,210,55],[0,212,116],[0,226,125,63],[0,178,74,39],[22,210,57],[0,212,120],[0,228,10,64],[22,210,61],[0,212,119],[0,226,126,63],[0,228,2,64],[0,180,74,48],[22,210,63],[0,212,117],[23,210,62],[0,212,113],[22,210,58],[0,212,111],[0,226,125,63],[22,210,57],[0,212,110],[0,226,123,63],[23,210,56],[0,212,109],[22,210,58],[22,210,60],[0,226,125,63],[23,210,62],[0,226,126,63],[22,210,60],[0,212,110],[22,210,58],[22,226,125,63],[23,210,55],[22,212,109],[0,180,74,49],[22,210,56],[0,212,108],[23,210,58],[0,212,107],[0,228,4,64],[22,210,62],[0,212,106],[0,226,126,63],[0,180,74,50],[22,210,66],[22,210,68],[23,210,67],[0,212,105],[22,212,107],[22,212,109],[0,228,8,64],[23,210,68],[0,212,113],[0,228,9,64],[0,180,74,51],[22,210,70],[0,212,115],[0,228,10,64],[22,210,72],[0,212,117],[0,228,12,64],[22,210,75],[0,212,120],[0,226,127,63],[0,180,74,52],[23,212,122],[0,228,13,64],[22,212,123],[0,228,14,64],[22,210,74],[0,226,126,63],[23,210,73],[0,212,123],[22,210,71],[22,210,70],[0,212,124],[22,210,71],[0,212,125],[23,210,72],[0,212,126],[22,210,74],[0,212,127],[0,226,121,63],[0,228,16,64],[0,178,74,41],[22,210,78],[23,210,80],[0,226,119,63],[22,210,80],[0,226,122,63],[0,180,74,53],[22,210,76],[0,226,126,63],[0,178,74,40],[23,210,74],[0,228,17,64],[22,210,71],[22,210,72],[0,228,20,64],[22,228,24,64],[23,210,71],[0,228,25,64],[22,210,73],[0,226,125,63],[22,210,75],[0,178,74,41],[23,210,77],[0,226,119,63],[44,210,79],[0,178,74,42],[22,210,83],[23,210,85],[0,226,118,63],[22,210,87],[0,228,24,64],[22,210,89],[0,226,119,63],[0,180,74,54],[23,210,93],[22,210,95],[22,210,94],[0,228,22,64],[45,226,118,63],[0,228,24,64],[22,210,92],[0,180,74,55],[22,210,91],[0,228,22,64],[23,228,21,64],[0,180,74,56],[22,210,92],[0,212,126],[22,210,93],[0,228,20,64],[0,180,74,57],[23,212,127],[0,228,21,64],[0,180,74,58],[22,212,125],[0,180,74,60],[22,212,127],[0,226,119,63],[0,228,25,64],[22,226,118,63],[0,228,29,64],[23,228,32,64],[0,180,74,61],[22,228,34,64],[0,180,74,62],[22,210,92],[0,228,37,64],[23,210,91],[0,228,38,64],[44,210,92],[0,228,40,64],[0,180,74,63],[22,210,93],[0,228,41,64],[23,226,119,63],[0,178,74,41],[22,210,89],[22,226,125,63],[0,178,74,40],[23,210,85],[22,228,42,64],[0,178,74,39],[22,210,83],[0,226,126,63],[22,210,79],[0,228,44,64],[23,210,77],[0,228,45,64],[22,210,74],[22,210,75],[0,226,127,63],[23,210,76],[0,180,74,64],[22,228,44,64],[0,180,74,65],[22,210,74],[23,210,75],[0,228,40,64],[22,210,76],[0,180,74,66],[22,210,78],[0,228,36,64],[0,178,74,40],[22,210,80],[0,226,123,63],[45,210,82],[0,226,122,63],[0,228,32,64],[0,178,74,41],[0,180,74,67],[22,210,86],[0,226,121,63],[0,228,28,64],[23,210,88],[0,212,126],[0,228,26,64],[0,180,74,69],[22,210,92],[0,212,125],[0,180,74,70],[22,210,96],[0,212,125],[0,228,22,64],[0,180,74,73],[22,210,99],[0,212,127],[0,226,122,63],[0,228,26,64],[23,210,98],[0,226,121,63],[0,228,29,64],[0,180,74,74],[22,210,97],[0,228,30,64],[45,228,34,64],[22,210,98],[0,178,74,42],[22,210,99],[0,228,30,64],[0,180,74,75],[22,228,28,64],[0,180,74,76],[23,210,98],[0,180,74,77],[22,210,97],[0,212,125],[0,228,24,64],[22,212,123],[0,228,14,64],[0,180,74,78],[23,210,97],[0,212,119],[0,226,119,63],[0,180,74,80],[22,210,96],[0,212,117],[0,228,0,64],[0,180,74,82],[22,212,121],[0,228,113,63],[22,210,95],[0,212,123],[0,228,102,63],[0,180,74,84],[23,210,94],[0,212,127],[0,226,118,63],[0,228,98,63],[22,210,93],[0,228,118,63],[0,180,74,85],[22,210,94],[0,228,119,63],[23,210,95],[0,226,119,63],[22,228,121,63],[0,180,74,86],[22,228,122,63],[0,180,74,87],[23,212,123],[22,180,74,89],[22,210,94],[0,212,121],[0,228,115,63],[22,212,119],[0,226,118,63],[0,180,74,91],[23,210,93],[0,212,121],[0,228,109,63],[0,178,74,43],[22,210,94],[0,212,125],[0,228,102,63],[0,180,74,93],[22,212,127],[0,228,98,63],[0,180,74,95],[23,210,93],[0,228,94,63],[22,210,91],[0,228,91,63],[0,180,74,96],[22,210,90],[0,226,117,63],[0,228,93,63],[22,210,88],[0,226,115,63],[0,228,94,63],[23,210,89],[0,228,97,63],[22,210,90],[0,226,117,63],[0,228,101,63],[0,180,74,97],[22,210,91],[0,212,123],[0,226,118,63],[0,180,74,99],[23,210,91],[0,212,125],[0,228,105,63],[0,180,74,103],[22,210,90],[0,212,127],[0,226,117,63],[0,228,91,63],[22,210,89],[0,210,88],[0,180,74,106],[22,210,86],[0,226,115,63],[0,228,90,63],[0,178,74,44],[23,210,87],[0,212,125],[0,228,102,63],[22,210,88],[0,210,90],[0,212,121],[0,226,118,63],[0,178,74,43],[22,210,92],[0,212,119],[0,228,127,63],[0,180,74,110],[23,210,94],[0,212,115],[0,226,119,63],[0,180,74,114],[22,210,91],[0,212,117],[0,212,119],[0,228,99,63],[22,210,89],[0,212,121],[0,226,118,63],[0,228,121,63],[0,178,74,44],[0,180,74,117],[23,210,87],[0,212,126],[0,226,115,63],[0,228,0,64],[22,210,88],[0,212,127],[0,228,4,64],[22,210,89],[0,212,123],[0,228,8,64],[22,210,90],[0,212,119],[0,226,117,63],[0,180,74,118],[23,210,93],[0,212,117],[0,226,118,63],[0,228,14,64],[0,180,74,121],[22,210,94],[0,212,115],[0,226,119,63],[0,228,0,64],[0,178,74,45],[22,210,95],[0,212,111],[0,226,121,63],[0,180,74,124],[23,210,94],[0,212,109],[0,228,1,64],[0,178,74,46],[0,180,74,126],[22,210,91],[0,212,105],[0,226,119,63],[0,180,74,127],[22,210,90],[0,212,103],[0,226,118,63],[0,228,2,64],[0,178,74,49],[22,210,86],[0,212,107],[0,226,126,63],[23,210,82],[0,212,109],[0,226,127,63],[0,228,12,64],[0,178,74,52],[22,210,80],[0,212,111],[0,226,126,63],[0,228,14,64],[0,178,74,53],[22,210,78],[0,212,115],[0,226,125,63],[0,228,12,64],[0,178,74,54],[23,210,75],[0,212,115],[0,228,1,64],[0,178,74,55],[22,210,76],[0,212,111],[0,226,126,63],[0,228,0,64],[22,210,73],[0,212,112],[0,226,125,63],[0,178,74,56],[22,210,70],[0,226,121,63],[23,210,69],[0,226,117,63],[0,178,74,58],[22,210,73],[0,226,113,63],[0,178,74,62],[22,210,71],[0,212,111],[0,226,107,63],[0,178,74,65],[23,210,75],[0,226,111,63],[0,228,127,63],[0,178,74,66],[22,210,78],[0,212,109],[22,210,76],[0,212,106],[23,210,72],[0,212,103],[0,226,110,63],[0,228,126,63],[22,210,68],[0,212,105],[0,226,105,63],[0,228,125,63],[22,210,66],[0,212,106],[0,226,101,63],[0,228,126,63],[22,210,62],[0,210,60],[0,212,108],[0,226,87,63],[0,178,74,69],[23,210,60],[0,212,112],[0,226,102,63],[0,178,74,72],[22,210,62],[0,212,113],[22,210,66],[0,212,115],[0,226,95,63],[0,178,74,76],[23,210,70],[0,226,91,63],[22,210,72],[0,226,90,63],[22,210,76],[22,210,74],[0,226,89,63],[23,210,70],[0,226,97,63],[0,178,74,78],[22,210,66],[0,212,116],[0,226,94,63],[0,178,74,82],[22,210,64],[0,178,74,86],[23,210,68],[0,226,81,63],[22,210,72],[0,212,115],[0,226,70,63],[0,178,74,87],[22,210,74],[0,226,71,63],[22,210,78],[0,212,114],[0,226,74,63],[23,210,80],[0,212,115],[22,210,80],[0,226,82,63],[22,210,76],[0,178,74,89],[23,210,74],[0,226,99,63],[0,178,74,91],[12,210,78],[0,212,84],[10,210,70],[0,226,94,63],[22,210,68],[0,226,74,63],[0,178,74,94],[23,210,72],[0,212,116],[0,226,65,63],[0,178,74,97],[22,210,76],[22,210,78],[0,226,67,63],[0,178,74,98],[22,210,82],[0,226,73,63],[23,210,80],[0,212,115],[22,210,76],[0,226,79,63],[22,210,72],[0,226,85,63],[23,210,68],[0,212,114],[0,226,98,63],[0,178,74,99],[22,210,72],[0,226,81,63],[0,228,0,64],[0,178,74,103],[22,210,74],[0,212,113],[0,226,61,63],[0,228,127,63],[0,178,74,108],[22,210,80],[0,212,112],[0,178,74,109],[23,210,82],[0,212,110],[0,226,66,63],[22,210,86],[0,226,67,63],[22,210,88],[0,212,108],[0,226,70,63],[23,210,90],[0,212,107],[0,226,75,63],[0,178,74,112],[22,210,88],[0,226,65,63],[0,178,74,117],[22,210,90],[0,212,106],[0,226,69,63],[0,178,74,119],[22,210,94],[23,210,94],[0,212,105],[0,226,74,63],[22,210,92],[0,212,103],[0,226,102,63],[22,210,88],[0,212,102],[0,226,113,63],[0,178,74,121],[23,210,86],[0,212,100],[0,226,117,63],[0,178,74,125],[22,210,87],[0,212,98],[0,226,118,63],[0,228,126,63],[0,178,74,127],[22,210,83],[0,212,97],[0,226,121,63],[22,210,85],[0,212,94],[0,226,122,63],[23,210,82],[0,212,92],[0,228,0,64],[22,210,80],[0,212,88],[0,226,121,63],[0,228,1,64],[22,210,78],[0,212,84],[23,210,76],[0,212,82],[0,226,125,63],[0,228,6,64],[22,210,74],[0,212,78],[0,226,2,64],[0,228,17,64],[22,210,70],[0,212,76],[0,226,20,64],[0,228,0,64],[23,210,68],[0,212,76],[0,226,0,64],[22,210,72],[0,212,80],[22,210,76],[0,212,82],[22,130,62,34],[0,132,69,31]];

function onPlaying() {
  var eventTime = 0;

  if (video.currentTime) {
    video.pause();
    video.currentTime = 0;
    video.play();
  }

  mpeInstrument.clear();
  clock.stop();
  clock.start();
  timedMidi.forEach((event, i) => {
    var deltaTime = event[0];
    var message = event.slice(1);
    eventTime += deltaTime;
    clock.setTimeout(e => {
      if (window.innerWidth > 600) {
        var newSpan = document.createElement('span');
        newSpan.innerHTML = JSON.stringify(message);
        newMidiMessages.push(newSpan);
      }
      mpeInstrument.processMidiMessage(message);
    }, BEAT_LENGTH_S * eventTime / BEAT_LENGTH_TICKS);
  });
}
video.addEventListener('playing', onPlaying);
window.addEventListener('touchend', function safariFix() {
  video.play();
  onPlaying();
  this.removeEventListener('touchend', safariFix);
});

function renderMpe() {
  var activeNotes = mpeInstrument.activeNotes();
  var newSpan = document.createElement('span');
  newSpan.innerHTML = JSON.stringify(activeNotes, null, '  ');
  var newHTML = newSpan.outerHTML;
  if (activeNotes.length && newHTML !== mpeOutput.innerHTML) {
    mpeOutput.innerHTML = newHTML;
  }
}

function renderMidi() {
  newMidiMessages.slice(-MAX_MIDI_MESSAGES).forEach(function(newEl) {
    midiInput.insertBefore(newEl, midiInput.children[0]);
  });
  newMidiMessages = [];
  if (midiInput.children.length > MAX_MIDI_MESSAGES) {
    Array.from(midiInput.children).slice(MAX_MIDI_MESSAGES).forEach(function(child) {
      child.remove();
    });
  }
}

function renderMpeVisualizer() {
  mpeW = mpeCanvas.width = mpeCanvas.clientWidth * 2;
  mpeH = mpeCanvas.height = mpeCanvas.clientHeight * 2;
  // Background
  mpeCtx.fillStyle = '#404040';
  mpeCtx.fillRect(0, 0, mpeW, mpeH);
  mpeCtx.fill();
  // Black key lines
  mpeCtx.strokeStyle = '#ffffff';
  mpeCtx.lineCap = 'round';
  mpeCtx.lineWidth = BLACK_KEY_LINE_WIDTH;
  BLACK_KEYS.forEach(function(i) {
    var x = KEY_CENTERS[i] * mpeW;
    mpeCtx.beginPath();
    mpeCtx.moveTo(x - BLACK_KEY_LINE_WIDTH / 2, mpeH / 5);
    mpeCtx.lineTo(x - BLACK_KEY_LINE_WIDTH / 2, mpeH / 2);
    mpeCtx.stroke();
  });
  // Key waves
  mpeCtx.strokeStyle = '#ffffff';
  mpeCtx.lineCap = 'butt';
  mpeCtx.lineWidth = mpeW / 30;
  for (var i = 0; i <= 13; i++) {
    if (BLACK_KEYS.indexOf(i) !== -1) continue;
    var x = (KEY_CENTERS[i] - 1 / 16) * mpeW + 10;
    var isPreviousKeyWhite = BLACK_KEYS.indexOf(i - 1) === -1;
    var startY = isPreviousKeyWhite ? mpeH * 1 / 10 : mpeH * 11 / 20;
    var endY = mpeH * 9 / 10;
    var colorStopInterval = isPreviousKeyWhite ? 0.1 : 0.2;
    // Lowlight
    var darkGrad = mpeCtx.createLinearGradient(0,startY,0,endY);
    darkGrad.addColorStop(0,'#404040');
    darkGrad.addColorStop(colorStopInterval,'#3A3A3A');
    darkGrad.addColorStop(1 - colorStopInterval,'#3A3A3A');
    darkGrad.addColorStop(1,'#404040');
    var darkGrad2 = mpeCtx.createLinearGradient(0, mpeH * 1 / 10, 0, mpeH * 11.5 / 20);
    darkGrad2.addColorStop(0,'#404040');
    darkGrad2.addColorStop(colorStopInterval,'#3A3A3A');
    darkGrad2.addColorStop(1 - colorStopInterval,'#3A3A3A');
    darkGrad2.addColorStop(1,'#404040');
    var lightGrad = mpeCtx.createLinearGradient(0,startY,0,endY);
    lightGrad.addColorStop(0,'#404040');
    lightGrad.addColorStop(colorStopInterval,'#4F4F4F');
    lightGrad.addColorStop(1 - colorStopInterval,'#4F4F4F');
    lightGrad.addColorStop(1,'#404040');
    var lightGrad2 = mpeCtx.createLinearGradient(0, mpeH * 1 / 10, 0, mpeH * 11.5 / 20);
    lightGrad2.addColorStop(0,'#404040');
    lightGrad2.addColorStop(colorStopInterval,'#4F4F4F');
    lightGrad2.addColorStop(1 - colorStopInterval,'#4F4F4F');
    lightGrad2.addColorStop(1,'#404040');
    // Black key highlight
    if (!isPreviousKeyWhite) {
      mpeCtx.strokeStyle = lightGrad2;
      mpeCtx.beginPath();
      mpeCtx.moveTo(x, mpeH * 1 / 10);
      mpeCtx.lineTo(x, mpeH * 11.5 / 20);
      mpeCtx.stroke();
    }
    // Lowlight
    mpeCtx.strokeStyle = darkGrad;
    mpeCtx.beginPath();
    mpeCtx.moveTo(x, startY);
    mpeCtx.lineTo(x, endY);
    mpeCtx.stroke();
    x -= mpeW / 16;
    // Black key lowlight
    if (!isPreviousKeyWhite) {
      mpeCtx.strokeStyle = darkGrad2;
      mpeCtx.beginPath();
      mpeCtx.moveTo(x, mpeH * 1 / 10);
      mpeCtx.lineTo(x, mpeH * 11.5 / 20);
      mpeCtx.stroke();
    }
    // Highlight
    mpeCtx.strokeStyle = lightGrad;
    mpeCtx.beginPath();
    mpeCtx.moveTo(x, startY);
    mpeCtx.lineTo(x, endY);
    mpeCtx.stroke();
  }
  // Notes
  var activeNotes = mpeInstrument.activeNotes();
  mpeCtx.lineWidth = 2;
  mpeCtx.fillStyle = '#00ffff';
  mpeCtx.strokeStyle = '#00ffff';
  activeNotes.forEach(function(note) {
    mpeCtx.globalAlpha = 0.5;
    mpeCtx.beginPath();
    var noteNumber = (note.noteNumber + note.pitchBend + 120) % 12;
    var noteXProportion = KEY_CENTERS[Math.floor(noteNumber)]
      + (noteNumber % 1) * (KEY_CENTERS[Math.ceil(noteNumber)] - KEY_CENTERS[Math.floor(noteNumber)]);
    var noteX = noteXProportion * mpeW;
    var noteY = (0.9 - note.timbre * 0.8) * mpeH;
    var noteRadius = 15 + Math.pow(note.pressure, 4) * 15;
    mpeCtx.ellipse(noteX, noteY, noteRadius, noteRadius, 0, 0, 2 * Math.PI);
    mpeCtx.closePath();
    mpeCtx.fill();
    mpeCtx.globalAlpha = 0.5;
    mpeCtx.stroke();
  });
}

function render(t) {
  if (window.innerWidth > 600) {
    if (!video.src) {
      video.src = 'https://d30pueezughrda.cloudfront.net/mpe.js/mpe-demo.mp4';
    }
    video.currentTime === 0 && video.readyState > 2 && video.play();
    renderMpe();
    renderMidi();
    renderMpeVisualizer();
  }
  window.requestAnimationFrame(render);
}
render();
