var AudioContext = window.AudioContext || window.webkitAudioContext;
var context = new AudioContext();
var clock = new window.WAAClock(context);
var mpeInstrument = new window.mpe();
var video = document.getElementById('mpe-video');
var mpeOutput = document.getElementById('mpe-output');
var midiInput = document.getElementById('midi-input');
var tabButtons = Array.from(document.getElementsByClassName('tab-button'));
var tabChildren = Array.from(document.getElementsByClassName('tab-child'));

var TEMPO = 120;
var BEAT_LENGTH_S = 60 / TEMPO;
var BEAT_LENGTH_TICKS = 960;

var timedMidi = [[98,177,74,60],[60,209,47],[62,225,0,64],[62,209,10],[136,211,5],[48,227,2,64],[62,211,12],[122,211,1],[190,133,48,44],[38,181,74,64],[18,213,37],[62,229,121,63],[2,147,50,127],[60,213,59],[60,229,0,64],[62,213,48],[62,229,124,63],[60,213,32],[64,131,50,0],[60,227,6,64],[52,149,48,127],[10,211,47],[60,227,0,64],[62,211,9],[104,133,48,32],[204,213,65],[40,145,49,127],[20,181,74,49],[62,213,70],[62,229,3,64],[62,213,59],[60,229,123,63],[62,213,77],[54,131,50,9],[8,229,125,63],[58,129,49,40],[2,213,67],[62,229,127,63],[62,213,58],[62,229,0,64],[60,213,12],[194,227,0,64],[52,211,62],[18,147,50,127],[44,179,74,63],[62,211,15],[122,211,7],[156,229,0,64],[28,213,43],[40,131,50,21],[22,229,122,63],[62,213,15],[338,225,0,64],[8,211,23],[22,209,73],[2,227,2,64],[54,147,50,127],[6,225,1,64],[2,211,61],[58,209,73],[2,227,127,63],[60,225,124,63],[2,211,24],[60,209,43],[2,227,125,63],[60,211,3],[60,209,1],[12,131,50,0],[156,149,48,127],[386,133,48,21],[20,227,0,64],[42,211,61],[32,147,50,127],[28,227,126,63],[62,211,31],[120,131,50,14],[2,211,36],[28,149,48,127],[96,211,0],[302,133,48,9],[82,147,50,127],[174,211,9],[56,179,74,79],[10,145,49,127],[52,211,21],[60,179,74,63],[62,211,5],[226,213,3],[20,229,119,63],[20,129,49,63],[40,213,71],[62,229,124,63],[62,213,24],[62,229,125,63],[62,213,4],[58,131,51,0],[78,227,0,64],[48,211,53],[48,149,48,127],[12,227,126,63],[62,211,0],[62,229,121,63],[62,213,64],[60,229,118,63],[62,213,22],[62,181,74,56],[60,213,10],[16,133,48,36],[22,147,51,127],[148,227,5,64],[60,211,37],[32,131,51,1],[132,225,0,64],[20,209,94],[62,225,125,63],[98,177,74,60],[60,209,47],[62,225,0,64],[62,209,10],[136,211,5],[48,227,2,64],[62,211,12],[122,211,1],[190,133,48,44],[38,181,74,64],[18,213,37],[62,229,121,63],[2,147,50,127],[60,213,59],[60,229,0,64],[62,213,48],[62,229,124,63],[60,213,32],[64,131,50,0],[60,227,6,64],[52,149,48,127],[10,211,47],[60,227,0,64],[62,211,9],[104,133,48,32],[204,213,65],[40,145,49,127],[20,181,74,49],[62,213,70],[62,229,3,64],[62,213,59],[60,229,123,63],[62,213,77],[54,131,50,9],[8,229,125,63],[58,129,49,40],[2,213,67],[62,229,127,63],[62,213,58],[62,229,0,64],[60,213,12],[194,227,0,64],[52,211,62],[18,147,50,127],[44,179,74,63],[62,211,15],[122,211,7],[156,229,0,64],[28,213,43],[40,131,50,21],[22,229,122,63],[62,213,15],[338,225,0,64],[8,211,23],[22,209,73],[2,227,2,64],[54,147,50,127],[6,225,1,64],[2,211,61],[58,209,73],[2,227,127,63],[60,225,124,63],[2,211,24],[60,209,43],[2,227,125,63],[60,211,3],[60,209,1],[12,131,50,0],[156,149,48,127],[386,133,48,21],[20,227,0,64],[42,211,61],[32,147,50,127],[28,227,126,63],[62,211,31],[120,131,50,14],[2,211,36],[28,149,48,127],[96,211,0],[302,133,48,9],[82,147,50,127],[174,211,9],[56,179,74,79],[10,145,49,127],[52,211,21],[60,179,74,63],[62,211,5],[226,213,3],[20,229,119,63],[20,129,49,63],[40,213,71],[62,229,124,63],[62,213,24],[62,229,125,63],[62,213,4],[58,131,51,0],[78,227,0,64],[48,211,53],[48,149,48,127],[12,227,126,63],[62,211,0],[62,229,121,63],[62,213,64],[60,229,118,63],[62,213,22],[62,181,74,56],[60,213,10],[16,133,48,36],[22,147,51,127],[148,227,5,64],[60,211,37],[32,131,51,1],[132,225,0,64],[20,209,94],[62,225,125,63],[98,177,74,60],[60,209,47],[62,225,0,64],[62,209,10],[136,211,5],[48,227,2,64],[62,211,12],[122,211,1],[190,133,48,44],[38,181,74,64],[18,213,37],[62,229,121,63],[2,147,50,127],[60,213,59],[60,229,0,64],[62,213,48],[62,229,124,63],[60,213,32],[64,131,50,0],[60,227,6,64],[52,149,48,127],[10,211,47],[60,227,0,64],[62,211,9],[104,133,48,32],[204,213,65],[40,145,49,127],[20,181,74,49],[62,213,70],[62,229,3,64],[62,213,59],[60,229,123,63],[62,213,77],[54,131,50,9],[8,229,125,63],[58,129,49,40],[2,213,67],[62,229,127,63],[62,213,58],[62,229,0,64],[60,213,12],[194,227,0,64],[52,211,62],[18,147,50,127],[44,179,74,63],[62,211,15],[122,211,7],[156,229,0,64],[28,213,43],[40,131,50,21],[22,229,122,63],[62,213,15],[338,225,0,64],[8,211,23],[22,209,73],[2,227,2,64],[54,147,50,127],[6,225,1,64],[2,211,61],[58,209,73],[2,227,127,63],[60,225,124,63],[2,211,24],[60,209,43],[2,227,125,63],[60,211,3],[60,209,1],[12,131,50,0],[156,149,48,127],[386,133,48,21],[20,227,0,64],[42,211,61],[32,147,50,127],[28,227,126,63],[62,211,31],[120,131,50,14],[2,211,36],[28,149,48,127],[96,211,0],[302,133,48,9],[82,147,50,127],[174,211,9],[56,179,74,79],[10,145,49,127],[52,211,21],[60,179,74,63],[62,211,5],[226,213,3],[20,229,119,63],[20,129,49,63],[40,213,71],[62,229,124,63],[62,213,24],[62,229,125,63],[62,213,4],[58,131,51,0],[78,227,0,64],[48,211,53],[48,149,48,127],[12,227,126,63],[62,211,0],[62,229,121,63],[62,213,64],[60,229,118,63],[62,213,22],[62,181,74,56],[60,213,10],[16,133,48,36],[22,147,51,127],[148,227,5,64],[60,211,37],[32,131,51,1],[132,225,0,64],[20,209,94],[62,225,125,63],[26,225,0,64],[96,177,74,60],[62,209,47],[62,225,0,64],[62,209,10],[136,211,5],[48,227,2,64],[62,211,12],[122,211,1],[228,181,74,64],[18,213,37],[62,229,121,63],[2,128,48,0],[60,213,59],[60,229,0,64],[62,213,48],[62,229,124,63],[60,213,32],[64,131,50,0],[60,227,6,64],[52,149,48,127],[10,211,47],[60,227,0,64],[62,211,9],[104,133,48,32],[204,213,65],[40,145,49,127],[20,181,74,49],[62,213,70],[62,229,3,64],[62,213,59],[60,229,123,63],[62,213,77],[54,131,50,9],[8,229,125,63],[58,129,49,40],[2,213,67],[62,229,127,63],[62,213,58],[62,229,0,64],[60,213,12],[194,227,0,64],[52,211,62],[18,147,50,127],[44,179,74,63],[62,211,15],[122,211,7],[156,229,0,64],[28,213,43],[40,131,50,21],[22,229,122,63],[62,213,15],[338,225,0,64],[8,211,23],[22,209,73],[2,227,2,64],[54,147,50,127],[6,225,1,64],[2,211,61],[58,209,73],[2,227,127,63],[60,225,124,63],[2,211,24],[60,209,43],[2,227,125,63],[60,211,3],[60,209,1],[12,131,50,0],[156,149,48,127],[386,133,48,21],[20,227,0,64],[42,211,61],[32,147,50,127],[28,227,126,63],[62,211,31],[120,131,50,14],[2,211,36],[28,149,48,127],[96,211,0],[302,133,48,9],[82,147,50,127],[174,211,9],[56,179,74,79],[10,145,49,127],[52,211,21],[60,179,74,63],[62,211,5],[226,213,3],[20,229,119,63],[20,129,49,63],[40,213,71],[62,229,124,63],[62,213,24],[62,229,125,63],[62,213,4],[58,131,51,0],[78,227,0,64],[48,211,53],[48,149,48,127],[12,227,126,63],[62,211,0],[62,229,121,63],[62,213,64],[60,229,118,63],[62,213,22],[62,181,74,56],[60,213,10],[16,133,48,36],[22,147,51,127],[148,227,5,64],[60,211,37],[32,131,51,1],[132,225,0,64],[20,209,94],[62,225,125,63],[24,133,48,64],[2,225,0,64]];

function onPlaying() {
  var eventTime = 0;

  mpeInstrument.clear();
  clock.stop();
  clock.start();
  timedMidi.forEach((event, i) => {
    var deltaTime = event[0];
    var message = event.slice(1);
    eventTime += deltaTime;
    clock.setTimeout(e => {
      midiInput.innerHTML = JSON.stringify(message, null, '  ');
      mpeInstrument.processMidiMessage(message);
    }, BEAT_LENGTH_S * eventTime / BEAT_LENGTH_TICKS);
  });
}
video.addEventListener('playing', onPlaying);

function onMpeUpdate(activeNotes) {
  mpeOutput.innerHTML = JSON.stringify(activeNotes, null, '  ');
}
mpeInstrument.subscribe(onMpeUpdate);

tabButtons.forEach(function(button) {
  button.addEventListener('mouseup', function (e) {
    tabButtons.concat(tabChildren).forEach(function(_button) {
      _button.classList.remove('active');
    });
    e.target.classList.add('active');
    var matchingTab = tabChildren.filter(function(tabChild) {
      return tabChild.id === e.target.dataset.tab;
    })[0];
    if (matchingTab) matchingTab.classList.add('active');
  });
});
